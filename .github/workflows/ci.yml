name: CI

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: read

jobs:
    lint:
        runs-on: ubuntu-latest

        steps:
            - id: checkout
              name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

            - id: setup_uv
              name: Install uv
              uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2
              with:
                  enable-cache: true

            - id: ruff
              name: Ruff lint
              run: uv run --with ruff ruff check .

            - id: bandit
              name: Bandit security scan
              run: >
                  uv run --with bandit
                  bandit -r
                  skills/jira-communication/scripts/
                  scripts/
                  -c pyproject.toml
                  --severity-level medium

    test:
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                python: ['3.10', '3.11', '3.12', '3.13']

        steps:
            - id: checkout
              name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

            - id: setup_uv
              name: Install uv
              uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2
              with:
                  enable-cache: true

            - id: tests
              name: Run tests (Python ${{ matrix.python }})
              run: >
                  uv run
                  --python ${{ matrix.python }}
                  --with pytest
                  --with atlassian-python-api
                  --with click
                  --with requests
                  python -m pytest tests/ -v
